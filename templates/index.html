<!DOCTYPE html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <title>Plant Monitor</title>
</head>
<body class="bg-light">
<div class="container mt-4">
    <h2>Plant State: {{ state }}</h2>
    
    <!-- State Dropdown -->
    <form action="/set_state" method="post" class="mb-4">
        <select name="plant_state" onchange="this.form.submit()" class="form-select">
            {% for s in ["Seedling", "Vegetation", "Flowering", "Late Flowering"] %}
            <option value="{{ s }}" {% if s == state %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>
    </form>
    <!-- Update button -->
    <div>
        <a href="/manual_update">
          <button>Update Sensor</button>
        </a>
        <br>
    </div>
    <div> 
        <p class="display 5"><b>Recent Reading:</b> {{actual.time}} </p>
    </div>
    <!-- Range Selector -->
    <select id="rangeSelect" onchange="loadChart()">
            <option value="60m">Last 60 Minutes</option>
            <option value="6h">Last 6 Hours</option>
            <option value="12h">Last 12 Hours</option>
            <option value="24h" selected>Last 24 Hours</option>
            <option value="7d">Last 7 Days</option>
    </select>
    <!-- Status Widgets -->
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card text-white bg-{{ temp_color }}">
                <div class="card-body">
                    <h5 class="card-title">Temperature</h5>
                    <p class="display-6">{{ actual.temp }}째F</p>
                    <small>Target Min: {{targets.temp[0]}}째F <br> Target Max: {{targets.temp[1]}}째F</small>
                </div>
            </div>
        </div>
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card text-white bg-{{ hum_color }}">
                <div class="card-body">
                    <h5 class="card-title">Humidity</h5>
                    <p class="display-6">{{ actual.hum }}%</p>
                    <small>Target Min: {{targets.hum[0]}}% <br> Target Max: {{targets.hum[1]}}%</small>
                </div>
            </div>
        </div>
    <div class="row g-3">
        <div class="col-md-4">
            <div class="card text-white bg-{{ soil_color }}">
                <div class="card-body">
                    <h5 class="card-title">Soil Moisture</h5>
                    <p class="display-6">{{ actual.soil }}%</p>
                    <small>Target Min: {{targets.soil[0]}}% <br>  Target Max: {{targets.soil[1]}}%</small>
                </div>
            </div>
        </div>
    </div>
    <div class="chart-row">
        <canvas id="tempChart"></canvas>
        <canvas id="humChart"></canvas>
        <canvas id="soilChart"></canvas>
    </div>
</div>
</body>
</html>

<script>

let tempChart, humChart, soilChart;

function loadCharts() {

    const range = document.getElementById("rangeSelect").value;

    fetch(`/api/history?range=${range}`)
    .then(res => res.json())
    .then(data => {

        const labels = data.timestamps.map(t =>
            new Date(t).toLocaleTimeString()
        );

        if (tempChart) tempChart.destroy();
        if (humChart) humChart.destroy();
        if (soilChart) soilChart.destroy();

        tempChart = createChart("tempChart", labels, data.temperature, "Temperature 째F");
        humChart = createChart("humChart", labels, data.humidity, "Humidity %");
        soilChart = createChart("soilChart", labels, data.soil, "Soil Moisture");
    });
}

function createChart(canvasId, labels, values, label) {

    return new Chart(document.getElementById(canvasId), {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: values,
                fill: false,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    ticks: { maxTicksLimit: 8 }
                }
            }
        }
    });
}

window.onload = loadCharts;

</script>


